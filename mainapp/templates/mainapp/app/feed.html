{% extends "mainapp/base/base_public.html" %}

{% block title %}Home - Nutriosity{% endblock %}

{% block bodyclass %}
	class="feed"
{% endblock %}

{% block afterscript %}
	{% load staticfiles %}
	<script type="text/javascript">

		var feedItems;

		/* This function takes data from feedItems and uses it to populate the page */
		function populatePageFromFeedItems() {
			$('.content-feed').html("");
			for(var index in feedItems) {
				var feedItem = feedItems[index];
				var upvoted = "";
				if(feedItem.upvoted) {
					upvoted = "upvoted";
				}

				/* Load expert images */
				var experts_html_string = '<div class="experts-pane"> ';
				for(var x = 0; x < feedItem.experts_array.length; x++) {
					if(x < 3) {
						var image_path = profile_path + feedItem.experts_array[x].image_path;
						experts_html_string += '<img data-pk="';
						experts_html_string += feedItem.experts_array[x].expert_profile_pk;
						experts_html_string += '" src="'+image_path+'"> ';
					}
				}
				experts_html_string += '</div>';

				/* Load feed items */
				var feedHTMLItem = '<div class="feed-item" data-pk="'+feedItem.pk+'"> \
					<div class="upvote-item '+upvoted+'"> \
						<img src="{% static "mainapp/images/upvote-arrow.png" %}"> \
						<span class="vote-count">'+feedItem.num_upvotes+'</span> \
					</div> \
					<div class="question-text">'+feedItem.text+'</div> ' + experts_html_string + 
				'</div>';
						
				$('.content-feed').append(feedHTMLItem);
			}
		}

		/* Get profile picture */
		var profile_picture = "{{ profile_picture }}";

		$('.filter-type').click(function() {
			if(!$(this).hasClass('selected')) {
				/* Make bold */
				$('.filter-type').removeClass('selected');
				$(this).addClass('selected');

				/* Reload page */
				toggleFeed($(this).data('state'));
			}
		});

		var profile_path = '{% static "mainapp/images/profile_pictures/" %}';

		/* LOAD EVERYTHING */
		feedItems = {{ feed_items | safe }}; // Get feedItems
		populatePageFromFeedItems(); // Populate the page

		/* This function toggles how the feed items are ordered */
		/* State is being changed to the the state argument */
		function toggleFeed(state) {
			/* First get's data in new order */
			var data = {
				state: state
			};
			console.log("State: " + state);

			HELPER.post("/api/get_feed_items/", data, function(data) {

				var returnData = JSON.parse(data);
				console.log(returnData);
				if(returnData.status == 1) { // Success
					feedItems = JSON.parse(returnData.feed_items);

					/* Update UI */
					populatePageFromFeedItems();
				}
				else { // Failure
					console.log('FAILURE!')
					if(returnData.error == 0) { // Not logged in
						console.log("not logged in but upvoting");
					}
					else if(returnData.error == 1) { // User doesn't exist

					}
					else if(returnData.error == 2) { // Question doesn't exist

					}
					else if(returnData.error == 3) { // Already upvoted or not upvoted yet

					}
					else {

					}
				}

				

			}, function(data) {

			});

			
		}

		/* Apply upvoted class */
		$('.upvote-item').click(function(e) {
			var currentUpvoteItem = $(this);
			var data = {
				question_pk: $(this).parent('.feed-item').data('pk')
			};
			var postString = "";

			if(!$(this).hasClass('upvoted')) { // upvote
				postString = "upvote_question";
			}
			else { // Remove upvote
				postString = "remove_upvote_question";
			}

			HELPER.post("/api/"+postString+"/", data, function(data) {

				var returnData = JSON.parse(data);
				if(returnData.status == 1) { // Success
					if(postString == "remove_upvote_question") {
						currentUpvoteItem.removeClass('upvoted');
						currentUpvoteItem.find('.vote-count').text(returnData.num_votes);
					}
					else 
					{
						currentUpvoteItem.addClass('upvoted');
						currentUpvoteItem.find('.vote-count').text(returnData.num_votes);
					}
				}
				else { // Failure
					if(returnData.error == 0) { // Not logged in
						console.log("not logged in but upvoting");
					}
					else if(returnData.error == 1) { // User doesn't exist

					}
					else if(returnData.error == 2) { // Question doesn't exist

					}
					else if(returnData.error == 3) { // Already upvoted or not upvoted yet

					}
					else {

					}
				}

				

			}, function(data) {

			});
			
			return false;
		});

		/* Go to discussion if feed item clicked */
		$('.feed-item').click(function() {
			var pk = $(this).data('pk');
			window.location.href = "/discussion/"+pk+"/";
		});

	</script>
{% endblock %}

{% block content %}
	<div class="filter-selector">
		<span class="filter-type selected" data-state="0">Popular</span>
		<span class="filter-type" data-state="1">Recent</span>
	</div>
	<div class="content-feed">
		<!-- <div class="feed-item">
			<div class="upvote-item">
				{% load staticfiles %}
				<img src="{% static 'mainapp/images/upvote-arrow.png' %}">
				<span class="vote-count">8</span>
			</div>
			<div class="question-text">Is there scientific evidence that a ketogenic diet is particularly effective for fat loss? What are the dangers of forcing your body into ketosis? Test words that are pretty common.</div>
			<div class="experts-pane">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
			</div>
		</div>
		<div class="feed-item">
			<div class="upvote-item">
				{% load staticfiles %}
				<img src="{% static 'mainapp/images/upvote-arrow.png' %}">
				<span class="vote-count">8</span>
			</div>
			<div class="question-text">What's the difference between soluble and insoluble fiber?</div>
			<div class="experts-pane">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
			</div>
		</div>
		<div class="feed-item">
			<div class="upvote-item">
				{% load staticfiles %}
				<img src="{% static 'mainapp/images/upvote-arrow.png' %}">
				<span class="vote-count">8</span>
			</div>
			<div class="question-text">What's the difference between soluble and insoluble fiber?</div>
			<div class="experts-pane">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
			</div>
		</div>
		<div class="feed-item">
			<div class="upvote-item">
				{% load staticfiles %}
				<img src="{% static 'mainapp/images/upvote-arrow.png' %}">
				<span class="vote-count">8</span>
			</div>
			<div class="question-text">What's the difference between soluble and insoluble fiber?</div>
			<div class="experts-pane">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
			</div>
		</div>
		<div class="feed-item">
			<div class="upvote-item">
				{% load staticfiles %}
				<img src="{% static 'mainapp/images/upvote-arrow.png' %}">
				<span class="vote-count">8</span>
			</div>
			<div class="question-text">What's the difference between soluble and insoluble fiber?</div>
			<div class="experts-pane">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
			</div>
		</div>
		<div class="feed-item">
			<div class="upvote-item">
				{% load staticfiles %}
				<img src="{% static 'mainapp/images/upvote-arrow.png' %}">
				<span class="vote-count">8</span>
			</div>
			<div class="question-text">What's the difference between soluble and insoluble fiber?</div>
			<div class="experts-pane">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
			</div>
		</div>
		<div class="feed-item">
			<div class="upvote-item">
				{% load staticfiles %}
				<img src="{% static 'mainapp/images/upvote-arrow.png' %}">
				<span class="vote-count">8</span>
			</div>
			<div class="question-text">What's the difference between soluble and insoluble fiber?</div>
			<div class="experts-pane">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
			</div>
		</div>
		<div class="feed-item">
			<div class="upvote-item">
				{% load staticfiles %}
				<img src="{% static 'mainapp/images/upvote-arrow.png' %}">
				<span class="vote-count">8</span>
			</div>
			<div class="question-text">What's the difference between soluble and insoluble fiber?</div>
			<div class="experts-pane">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
			</div>
		</div>
		<div class="feed-item">
			<div class="upvote-item">
				{% load staticfiles %}
				<img src="{% static 'mainapp/images/upvote-arrow.png' %}">
				<span class="vote-count">8</span>
			</div>
			<div class="question-text">What's the difference between soluble and insoluble fiber?</div>
			<div class="experts-pane">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
				<img src="{% static 'mainapp/images/bart-de-jonghe.png' %}">
			</div>
		</div> -->
	</div>
{% endblock %}